name: gitsummary release notes

on:
  release:
    types: [published]

permissions:
  contents: write
  pull-requests: write

jobs:
  release-notes:
    runs-on: ubuntu-latest
    env:
      GITSUMMARY_PROVIDER: openai
      GITSUMMARY_OPENAI_MODEL: gpt-5.1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install gitsummary
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install .

      - name: Ensure OpenAI key is configured
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "${OPENAI_API_KEY}" ]; then
            echo "::error::Missing OPENAI_API_KEY. Add it as a GitHub Actions secret (Settings → Secrets and variables → Actions)."
            exit 1
          fi

      - name: Compute revision range
        id: range
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          TAG: ${{ github.event.release.tag_name }}
        run: |
          set -euo pipefail
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

          # Find previous published release (excluding drafts). If none, fall back to repo root.
          PREV_TAG="$(gh api "repos/${GITHUB_REPOSITORY}/releases?per_page=20" --jq ".[] | select(.draft==false) | .tag_name" | awk -v tag="${TAG}" '$0!=tag {print; exit}' || true)"
          if [ -n "${PREV_TAG}" ]; then
            echo "prev_tag=${PREV_TAG}" >> "$GITHUB_OUTPUT"
            echo "range=${PREV_TAG}..${TAG}" >> "$GITHUB_OUTPUT"
          else
            ROOT_SHA="$(git rev-list --max-parents=0 HEAD | tail -n 1)"
            echo "prev_tag=" >> "$GITHUB_OUTPUT"
            echo "range=${ROOT_SHA}..${TAG}" >> "$GITHUB_OUTPUT"
          fi

      - name: Analyze commits
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITSUMMARY_PROVIDER: openai
        run: |
          gitsummary analyze "${{ steps.range.outputs.range }}" --no-use-llm --verbose

      - name: Generate release notes markdown
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITSUMMARY_PROVIDER: openai
          TAG: ${{ steps.range.outputs.tag }}
          RANGE: ${{ steps.range.outputs.range }}
        run: |
          mkdir -p release-notes
          gitsummary generate release-notes "${RANGE}" --format markdown --output "release-notes/${TAG}.md"

      - name: Update GitHub Release body
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ steps.range.outputs.tag }}
        run: |
          gh release edit "${TAG}" --notes-file "release-notes/${TAG}.md"

      - name: Create pull request with release note file
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "docs(release): add release notes for ${{ steps.range.outputs.tag }}"
          title: "Release notes: ${{ steps.range.outputs.tag }}"
          body: "Automated release notes generated by gitsummary."
          branch: "gitsummary/release-notes/${{ steps.range.outputs.tag }}"
          add-paths: |
            release-notes/${{ steps.range.outputs.tag }}.md
