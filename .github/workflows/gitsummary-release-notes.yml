name: gitsummary release notes

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  release-notes:
    runs-on: ubuntu-latest
    env:
      GITSUMMARY_PROVIDER: openai
      GITSUMMARY_OPENAI_MODEL: gpt-5.1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch Git Notes (read-only artifacts cache)
        run: |
          set -euo pipefail
          git fetch origin refs/notes/intent:refs/notes/intent || true
          git fetch origin refs/notes/report/release-note:refs/notes/report/release-note || true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install gitsummary
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install .

      - name: Ensure OpenAI key is configured
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "${OPENAI_API_KEY}" ]; then
            echo "::error::Missing OPENAI_API_KEY. Add it as a GitHub Actions secret (Settings → Secrets and variables → Actions)."
            exit 1
          fi

      - name: Compute revision range
        id: range
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          TAG: ${{ github.event.release.tag_name }}
        run: |
          set -euo pipefail
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

          # Find previous published release (excluding drafts). If none, fall back to repo root.
          PREV_TAG="$(gh api "repos/${GITHUB_REPOSITORY}/releases?per_page=20" --jq ".[] | select(.draft==false) | .tag_name" | awk -v tag="${TAG}" '$0!=tag {print; exit}' || true)"
          if [ -n "${PREV_TAG}" ]; then
            echo "prev_tag=${PREV_TAG}" >> "$GITHUB_OUTPUT"
            echo "range=${PREV_TAG}..${TAG}" >> "$GITHUB_OUTPUT"
          else
            ROOT_SHA="$(git rev-list --max-parents=0 HEAD | tail -n 1)"
            echo "prev_tag=" >> "$GITHUB_OUTPUT"
            echo "range=${ROOT_SHA}..${TAG}" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate release notes
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITSUMMARY_PROVIDER: openai
          GITSUMMARY_OPENAI_MODEL: gpt-5.1
        run: |
          TAG="${{ steps.range.outputs.tag }}"
          RANGE="${{ steps.range.outputs.range }}"
          OUT="$RUNNER_TEMP/release-notes-${TAG}.md"
          gitsummary ci release-notes "${RANGE}" --format markdown --output "$OUT"
          echo "out=${OUT}" >> "$GITHUB_OUTPUT"
        id: ci_notes

      - name: Upload release notes artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-notes-${{ steps.range.outputs.tag }}
          path: ${{ steps.ci_notes.outputs.out }}

      - name: Update GitHub Release body
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ steps.range.outputs.tag }}
        run: |
          gh release edit "${TAG}" --notes-file "${{ steps.ci_notes.outputs.out }}"
